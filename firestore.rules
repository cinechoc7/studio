/**
 * @fileoverview Firestore Security Rules for Package Tracking Application
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure admin experience while allowing for public tracking.
 * Administrative actions are restricted to authenticated users, while public package
 * information is readable by anyone who has the specific package ID.
 *
 * Data Structure:
 * - /packages/{packageId}: Stores public package information.
 * - /admin_updates/{updateId}: Stores administrative updates.
 *
 * Key Security Decisions:
 * - Public Read Access for Tracking: A single package document is publicly readable
 *   to facilitate easy tracking without authentication. Listing the entire collection is denied.
 * - Admin-Only Management: Creating, updating, and deleting packages is restricted
 *   to authenticated admin users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the 'packages' collection.
     * @path /packages/{packageId}
     */
    match /packages/{packageId} {
      /**
       * @allow (get): Allows any user (authenticated or not) to read a single package document.
       * This is essential for the public tracking page.
       * @deny (list): Prevents anyone from reading the entire list of packages.
       */
      allow get: if true;

      /**
       * @allow (list, create, update, delete): Restricts list, create, update, and delete
       * operations to authenticated users only. This secures the admin dashboard and actions.
       */
      allow list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Restricts all access to admin_updates to authenticated users.
     * @path /admin_updates/{updateId}
     */
    match /admin_updates/{updateId} {
      allow read, create, update, delete: if isSignedIn();
    }

    /**
     * @description Helper function to check if a user is authenticated.
     * @returns {boolean} True if request.auth is not null.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}
